---
title: 基于OpenCv的人脸口罩识别
date: 2020-06-18
tags:
 - 图像处理
categories:
 - technical
---



## 研究意义和背景 

​               新型冠状病毒肺炎（Corona Virus Disease 2019，COVID-19），简称“新冠 肺炎”，世界卫生组织命名为“2019冠状病毒病”[1-2]，是指2019新型冠状病毒 感染导致的肺炎。新冠肺炎疫情是新中国成立以来传播速度最快、感染范围最广、防控难度最大的一次重大突发事件，它对城市治理体系和治理能力提出巨大的挑战。经过我国医护人员以及群众们的努力抗疫，新冠肺炎在我国短短 几个月便得到了控制。

​               新冠战“疫”胜利的核心因素是控制病毒传播、治疗感染患者，在全国范围内统一限制人员流动性的措施下，城市作为疫情歼灭的主战场，社区作为城市治理的基本单元，称为了疫情防控的基础和关键环节。通过整合视频监控、人脸抓拍等多类视频图像采集方案，充分发挥深度学习、人工智能的潜力，为疫情防护提供新手段，有效遏制疫情蔓延势头，提升社会运行效率。

​               伴随着计算机在处理图像方面智能化技术的飞速发展趋势,硬件设备和图像处理技术的不断提高发展,目标特征识别技术也在快速发展。利用现有的资源，基于视频AI技术以及大数据分析应用，通过横向拓展视频的应用面，充分挖掘疫情防控的应用场景，为公安、卫健、疫情指挥部等实现科学防控、智能防控、应急处置、防控预案等工作提供有力支撑。




## 人脸识别技术现状

​               目前成熟的人脸识别技术主要有科大讯飞、Face++、百度AI等，三者的对比主要如表1.1所示。

​                                                        表1.1 三种地面站技术参数比较

| SDK厂家  |       类型       | 准确率 |                 识别时间                  |            使用场景            |
| :------: | :--------------: | :----: | :---------------------------------------: | :----------------------------: |
| 科大讯飞 | 人脸识别（1：N） | 99.4%  |                  1秒以内                  |  考勤系统、远程认证、门禁系统  |
|  Face++  | 人脸识别（1：N） |  99%   |     200ms提取人脸的特征，结果响应1-3s     | 刷脸门禁、安防监控、智能照片库 |
|  百度AI  | 人脸识别（1：N） |  99%   | 支持百万级人脸库，检索速度控制在500ms以内 |  安防监控、门禁闸机、签到考勤  |

​                由表可知，这些人脸识别技术的识别准确率十分精准，误差率极小，但是结合自身要求，以上三种技术均不在考虑范围内。人士不小心也会中招。




## 系统设计

1.需求分析

​                 戴口罩人脸检测技术通过深度学习，对人脸进行预处理、检测分割、人脸分类，将戴口罩人脸、未戴口罩人脸进行区分。

​                系统获取的人脸图片由于受到各种条件的限制和随机干扰（如光照、角度），往往不能直接使用，必须在图片处理的早期阶段对它进行灰度校正、噪声过滤等图像预处理。人脸图片预处理过程主要包括人脸图片的光线补偿、灰度变换、直方图均衡化、归一化、几何校正、滤波以及锐化等。进行预处理后可以得到8位的灰度图片。

2.系统方案选择

​                 根据题目的要求，利用图像处理的知识，识别没有戴口罩的人。简化为任务流程如图1.1所示。

​                                                    ![](asset/20200307/windows10.png)

​                                                              图1.1 是否佩戴口罩检测流程图

​                方案的整体思路是通过处理摄像头采集到的图像，与训练的人脸口罩模型进行对比，最终判断出结果。考虑到识别需要一定的实时性以及较强的计算效率，所以识别的软件部分选择开源的OpenCV，硬件选择树莓派3b+以及树莓派摄像头模块。每个识别的项目都需要完成检测和数据收集、训练识别器以及最终的识别，具体到口罩识别，就需要完成人脸口罩检测数据收集、训练识别器以及人脸口罩识别。因为OpenCV自带识别模型与题目相关的只有人脸识别的模型，因此需要自己手动训练构造一个人脸口罩的模型。

 

## 系统实现

​                首先需要获取戴口罩的人脸与未戴口罩的人脸之间的差异。如果检测系统只是满足若干个人脸识别的需求的话，采集这几个人的不同状态下的人脸，用作模型建立的材料即可。如果需要满足大多数的识别场景的话，需要找不同年龄、情景下的戴口罩的照片，并且这些照片的质量必定参差不齐，需要对照片进行一定的处理。为了避免有些照片人脸以及口罩所占比例较小，难以识别，因此对照片进行裁剪处理，通过OpenCV识别人脸，裁剪不需要的背景噪音。将戴口罩的人脸作为正样本，不戴口罩的人脸作为负样本，负样本需要比正样本多，才能有效降低误检率。部分代码如下所示：
import pandas as pd

import cv2

names=pd.read_excel('data\\imgName.xlsx')['names']# 读取所有照片名字

i=100000 #用于重新命名

for imagepath in names:

  \#读取图片

  img = cv2.imread(imagepath)

  \#转成灰度

  gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

  \#人脸识别器

  detector = cv2.CascadeClassifier('haarcascades\\haarcascade_frontalface_default.xml')

  \#获取人脸位置

  faces = detector.detectMultiScale(gray, 1.1, 5)

  for (x, y, w, h) in faces:

​    \#裁减图片

​    gray = gray[y:y+h,x:x+w] # 裁剪坐标为[y0:y1, x0:x1]

​    \#如果人脸不为空

​    try:

​      \# 保存裁减后的灰度图

​     cv2.imwrite('Q:\\GraduationProject\\mask\\gray1\\'+str(i)+'.jpg', gray)

​      i += 1

​    except:

​      print()

​                其次构建口罩识别的模型。采用opencv_createsamples.exe创建样本描述文件，再将样本描述文件导入opencv_traincascade训练，运行traincascade.bat等待xml文件生成，当击中率和虚警率达到项目要求时，即可停止训练，使用训练出来的xml来进行口罩人脸识别。部分代码如下所示：

import cv2

detector= cv2.CascadeClassifier('haarcascades\\haarcascade_frontalface_default.xml')

mask_detector=cv2.CascadeClassifier('data\\cascade.xml')

cap = cv2.VideoCapture(0)

 while True:

  ret, img = cap.read()

  gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

  faces = detector.detectMultiScale(gray, 1.1, 3)

  for (x, y, w, h) in faces:

​    \#参数分别为 图片、左上角坐标，右下角坐标，颜色，厚度

​    face=img[y:y+h,x:x+w] # 裁剪坐标为[y0:y1, x0:x1]

​    mask_face=mask_detector.detectMultiScale(gray, 1.1, 5)

​    for (x2,y2,w2,h2) in mask_face:

​      cv2.rectangle(img, (x2, y2), (x2 + w2, y2 + h2), (0, 0, 255), 2)

  cv2.imshow('Cheney', img)

  cv2.waitKey(3)

cap.release()

cv2.destroyAllWindows()



## 总结

​               由于硬件条件的限制，基于树莓派和OpenCv的戴口罩检测实际效果可能远不及科大讯飞、百度AI这类的付费人脸识别系统。同时也要考虑环境因素，比如光线、物体数量等都会对该系统的识别造成一定的影响。由于正样本的数量限制，也会导致识别出现一定的偏差。应该尽可能多的找一些正样本、负样本数量，训练一个准确率更高的模型。

​               随着硬件设备和图像技术的发展，开源的图像识别技术的准确率、实时性也会有较大的提升，在日常的生活中也能发挥更大的用处，创造更多的社会价值。就目前来说，类似的人脸口罩识别系统对防疫工作有巨大的辅助作用，能够做到长效、智能防控。同时随着5G、物联网等新技术的出现和发展，今后图像识别将会不断地在生活中得到应用和推广。